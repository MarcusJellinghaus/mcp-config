name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # Matches semantic version tags like 0.1.0, 1.2.3
      - '[0-9]+.[0-9]+.[0-9]+-*'  # Matches pre-release tags like 0.1.0-rc1

  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed for setuptools-scm

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build setuptools-scm[toml]>=8.0

    - name: Verify version matches tag
      run: |
        # Get the tag name
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TAG_NAME="${{ inputs.tag }}"
        else
          TAG_NAME="${{ github.ref_name }}"
        fi

        echo "Tag: $TAG_NAME"

        # Install package to get version
        python -m pip install -e .

        # Get version from package
        PACKAGE_VERSION=$(python -c "from mcp_config import __version__; print(__version__)")
        echo "Package version: $PACKAGE_VERSION"

        # Verify they match (allowing for setuptools-scm additions)
        if [[ ! "$PACKAGE_VERSION" =~ ^"$TAG_NAME" ]]; then
          echo "âŒ Error: Tag $TAG_NAME does not match package version $PACKAGE_VERSION"
          exit 1
        fi

        echo "âœ… Version verification passed"

    - name: Build package
      run: |
        python -m build

    - name: Check distribution
      run: |
        ls -lh dist/
        echo "Built packages:"
        ls dist/

    - name: Extract changelog for this version
      id: changelog
      run: |
        TAG_NAME="${{ github.ref_name }}"

        if [ -f "CHANGELOG.md" ]; then
          CHANGELOG=$(sed -n "/## \[${TAG_NAME}\]/,/## \[/p" CHANGELOG.md | sed '$ d')
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release ${TAG_NAME}"
          fi
          echo "$CHANGELOG" > release_notes.md
        else
          {
            echo "Release ${TAG_NAME}"
            echo ""
            echo "See git history for changes."
          } > release_notes.md
        fi

        echo "Release notes:"
        cat release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        files: |
          dist/*
        draft: false
        prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Uncomment this section when ready to publish to PyPI
    # - name: Publish to PyPI
    #   uses: pypa/gh-action-pypi-publish@release/v1
    #   with:
    #     password: ${{ secrets.PYPI_API_TOKEN }}
    #     skip-existing: true

    - name: Summary
      run: |
        echo "âœ… Release ${{ github.ref_name }} completed successfully!"
        echo "ðŸ“¦ Built and published artifacts"
        echo "ðŸ”– GitHub release created"
